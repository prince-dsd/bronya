########################################
# BASE â€” Development image
########################################
FROM python:3.11-slim

ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    NODE_ENV=development

# ----------------------------------------------------
# Install full dev toolchain (for mysqlclient, lxml, etc.)
# ----------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl git build-essential gcc g++ make \
    pkg-config \
    libxml2-dev libxslt-dev \
    zlib1g-dev \
    libffi-dev libssl-dev \
    default-libmysqlclient-dev \
    openssh-client \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# ----------------------------------------------------
# Install Node.js (latest LTS 24.x)
# ----------------------------------------------------
RUN curl -fsSL https://deb.nodesource.com/setup_24.x | bash - \
    && apt-get install -y --no-install-recommends nodejs \
    && rm -rf /var/lib/apt/lists/*

# PM2 for running multiple crawlers
RUN npm install -g pm2

# ----------------------------------------------------
# Install Python tooling
# ----------------------------------------------------
RUN pip install --no-cache-dir --upgrade pip setuptools wheel \
    && pip install --no-cache-dir poetry

WORKDIR /app

# ----------------------------------------------------
# Copy dependency metadata first (layer cache)
# ----------------------------------------------------
COPY pyproject.toml poetry.lock* ./

RUN poetry config virtualenvs.create false \
    && poetry install --no-interaction --no-ansi

# ----------------------------------------------------
# Copy full project
# ----------------------------------------------------
COPY . .

# ----------------------------------------------------
# Expose common dev ports
# ----------------------------------------------------
EXPOSE 3000 8000 9229

# ----------------------------------------------------
# DEV MODE: Keep container alive forever
# ----------------------------------------------------
CMD ["sleep", "infinity"]
